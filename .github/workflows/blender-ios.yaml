name: Blender iOS build (Fixed Paths)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14

    steps:
      - name: Install tools
        run: |
          brew update
          brew install git-lfs cmake svn
          git lfs install

      - name: Clone Blender (projects.blender.org) with LFS
        run: |
          # Clonamos en la carpeta 'blender'
          git clone https://projects.blender.org/blender/blender.git blender
          cd blender
          git checkout ios
          git lfs fetch origin
          git lfs pull

      - name: Descargar librerías iOS (script oficial)
        working-directory: blender
        run: |
          # make_update.py descarga las librerías en ../lib (hermana de blender)
          python3 ./build_files/utils/make_update.py --use-ios-libraries
          
      - name: Verificar Librerías (Diagnóstico)
        run: |
          echo "Verificando contenido de ../lib/ios_arm64..."
          if [ -d "lib/ios_arm64" ]; then
            ls -la lib/ios_arm64
          else
            echo "Aviso: lib/ios_arm64 no existe en la raíz, buscando en ../lib"
            ls -la lib/ios_arm64 || true
          fi

      - name: Configure CMake (iOS)
        working-directory: blender
        run: |
          # AÑADIDO: -DLIBDIR=../lib para corregir la ruta de búsqueda
          cmake -S . -B build_ios -G Xcode \
            -DLIBDIR=../lib \
            -DCMAKE_SYSTEM_NAME=iOS \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=17.0 \
            -DCMAKE_XCODE_ATTRIBUTE_CODE_SIGNING_ALLOWED=NO \
            -DCMAKE_XCODE_ATTRIBUTE_CODE_SIGN_IDENTITY="" \
            -DCMAKE_XCODE_ATTRIBUTE_DEVELOPMENT_TEAM=""

      - name: Build Blender (Release)
        working-directory: blender
        run: |
          # Compilamos la configuración Release
          cmake --build build_ios --config Release --parallel 3

      - name: Prepare IPA
        working-directory: blender
        run: |
          cd build_ios
          mkdir Payload
          # Movemos la app a la estructura Payload
          cp -r Release-iphoneos/Blender.app Payload/
          
          # Quitamos firma rota
          codesign --remove-signature Payload/Blender.app || true
          
          # Creamos IPA
          zip -r Blender_iOS_Unsigned.ipa Payload

      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Blender_iOS_ReadyToSign
          path: blender/build_ios/Blender_iOS_Unsigned.ipa
