name: Blender iOS build (Corrected)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14

    steps:
      - name: Install tools
        run: |
          brew update
          brew install git-lfs cmake svn
          git lfs install

      - name: Clone Blender (projects.blender.org) with LFS
        run: |
          # Clonamos en la carpeta 'blender'
          git clone https://projects.blender.org/blender/blender.git blender
          cd blender
          git checkout ios
          git lfs fetch origin
          git lfs pull

      - name: Descargar librerías iOS (script oficial)
        working-directory: blender
        run: |
          # Este script descarga las librerías precompiladas necesarias
          python3 ./build_files/utils/make_update.py --use-ios-libraries
          make update

      - name: Configure CMake (iOS)
        working-directory: blender  # <--- CORRECCIÓN IMPORTANTE
        run: |
          # Se ejecuta DENTRO de la carpeta blender
          cmake -S . -B build_ios -G Xcode \
            -DCMAKE_SYSTEM_NAME=iOS \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=17.0 \
            -DCMAKE_XCODE_ATTRIBUTE_CODE_SIGNING_ALLOWED=NO \
            -DCMAKE_XCODE_ATTRIBUTE_CODE_SIGN_IDENTITY="" \
            -DCMAKE_XCODE_ATTRIBUTE_DEVELOPMENT_TEAM=""

      - name: Build Blender (Release)
        working-directory: blender  # <--- CORRECCIÓN IMPORTANTE
        run: |
          # Compilamos la configuración Release
          cmake --build build_ios --config Release --parallel 3

      - name: Prepare IPA
        working-directory: blender  # <--- CORRECCIÓN IMPORTANTE
        run: |
          cd build_ios
          mkdir Payload
          # Movemos la app a la estructura Payload requerida por iOS
          cp -r Release-iphoneos/Blender.app Payload/
          
          # Eliminamos firmas previas para evitar conflictos al firmar después
          codesign --remove-signature Payload/Blender.app || true
          
          # Creamos el IPA
          zip -r Blender_iOS_Unsigned.ipa Payload

      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Blender_iOS_ReadyToSign
          # La ruta debe incluir 'blender/' porque es donde se generó
          path: blender/build_ios/Blender_iOS_Unsigned.ipa
